<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ConfiguraciÃ³n Inicial del Entorno | NICS CyberLab</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-950 text-slate-100 min-h-screen flex">

 <!-- ğŸ”¹ PANEL IZQUIERDO: BOTONES DE ACCIÃ“N -->
<aside class="w-72 bg-slate-900/90 p-6 flex flex-col space-y-6 border-r border-slate-800 shadow-lg">
  <h1 class="text-xl font-semibold text-sky-400 border-b border-slate-700 pb-3 mb-3">
    âš™ï¸ Acciones
  </h1>

  <!-- Indicador de estado -->
  <div id="status-card" class="bg-slate-800/80 border border-slate-700 rounded-lg p-4 flex items-center space-x-3 shadow-sm transition-all duration-300">
    <div id="status-dot" class="w-3 h-3 rounded-full bg-rose-500 animate-pulse"></div>
    <div>
      <p id="status-text" class="text-slate-300 text-sm font-medium">ConfiguraciÃ³n no guardada</p>
      <p class="text-slate-500 text-xs">Ãšltimo cambio: â€”</p>
    </div>
  </div>

  <!-- Botones -->
  <button id="save-config"
    class="py-3 rounded-lg text-white font-semibold shadow-md transition-all duration-200 hover:scale-[1.02]"
    style="background: linear-gradient(135deg, #3b82f6, #60a5fa);">
    ğŸ’¾ Guardar ConfiguraciÃ³n
  </button>

  <button id="apply-config"
    class="py-3 rounded-lg text-white font-semibold shadow-md transition-all duration-200 hover:scale-[1.02]"
    style="background: linear-gradient(135deg, #10b981, #34d399);">
    ğŸš€ Ejecutar Generador
  </button>

  <button id="destroy-config"
    class="py-3 rounded-lg text-white font-semibold shadow-md transition-all duration-200 hover:scale-[1.02]"
    style="background: linear-gradient(135deg, #f43f5e, #fb7185);">
    ğŸ§¨ Destruir ConfiguraciÃ³n
  </button>

  <div class="text-sm text-slate-400 border-t border-slate-700 pt-4 mt-6">
    <p><strong>Nota:</strong> Solo el administrador puede ejecutar o destruir configuraciones.</p>
  </div>
</aside>


  <!-- ğŸ”¹ PANEL DERECHO: CONTENIDO PRINCIPAL -->
  <main class="flex-1 overflow-y-auto p-10 space-y-8">

    <!--  Redes y Router -->
    <section class="bg-slate-900/80 p-6 rounded-xl border border-slate-800 shadow-md">
      <h2 class="text-xl font-semibold text-sky-400 mb-4">ğŸŒ Redes y Router</h2>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm text-slate-400 mb-1">Nombre de red externa</label>
          <input id="red_externa" value="red_externa" class="input" readonly />
        </div>
        <div>
          <label class="block text-sm text-slate-400 mb-1">CIDR externa</label>
          <input id="cidr_externa" value="10.0.2.0/24" class="input editable" />
        </div>

        <div>
          <label class="block text-sm text-slate-400 mb-1">Nombre de red privada</label>
          <input id="red_privada" value="red_privada" class="input" readonly />
        </div>
        <div>
          <label class="block text-sm text-slate-400 mb-1">CIDR privada</label>
          <input id="cidr_privada" value="192.168.100.0/24" class="input editable" />
        </div>

        <div>
          <label class="block text-sm text-slate-400 mb-1">Nombre del router</label>
          <input id="router_privado" value="router_privado" class="input" readonly />
        </div>
        <div>
          <label class="block text-sm text-slate-400 mb-1">DNS</label>
          <input id="dns_nameservers" value="8.8.8.8, 1.1.1.1" class="input editable" />
        </div>
      </div>
    </section>

    <!-- ğŸ”’ Grupo de Seguridad -->
 <!-- ğŸ”’ Grupo de Seguridad -->
<section class="bg-slate-900/80 p-6 rounded-xl border border-slate-800 shadow-md">
  <h2 class="text-xl font-semibold text-sky-400 mb-4">ğŸ”’ Grupo de Seguridad</h2>
  <div class="grid grid-cols-2 gap-4">
    <div>
      <label class="block text-sm text-slate-400 mb-1">Nombre del grupo</label>
      <input id="sg_name" value="sg_wazuh_suricata" class="input" readonly />
    </div>

    <div class="flex flex-col justify-center">
      <label class="block text-sm text-slate-400 mb-1">Reglas permitidas</label>
      <div class="flex flex-wrap gap-4 text-sm">
        <label><input type="checkbox" checked> SSH</label>
        <label><input type="checkbox" checked> ICMP</label>
        <label><input type="checkbox" checked> HTTP</label>
        <label><input type="checkbox" checked> HTTPS</label>
      </div>
    </div>

    <!-- ğŸ”§ Puertos personalizados -->
    <div class="col-span-2 mt-4">
      <label class="block text-sm text-slate-400 mb-1">
        Puertos adicionales (separados por ;)
      </label>
      <input id="custom_ports" 
             placeholder="Ejemplo: 8080;9000;1337"
             class="input editable font-mono text-sm"
             oninput="validarPuertos()">
      <p class="text-xs text-slate-500 mt-1">
        Puedes aÃ±adir puertos TCP adicionales separados por <code>;</code>.  
        Ejemplo: <span class="text-sky-400">8080;9000;1337</span>
      </p>
      <p id="puertos-error" class="text-xs text-rose-400 mt-1 hidden">
        âš ï¸ Uno o mÃ¡s puertos no son vÃ¡lidos (deben estar entre 1 y 65535).
      </p>
    </div>
  </div>
</section>


    <!--  ImÃ¡genes Base -->
    <section class="bg-slate-900/80 p-6 rounded-xl border border-slate-800 shadow-md">
      <h2 class="text-xl font-semibold text-sky-400 mb-4">ğŸ’½ ImÃ¡genes Base</h2>
      <p class="text-slate-400 mb-3 text-sm">Selecciona quÃ© imÃ¡genes deseas generar en OpenStack.</p>
      <div class="space-y-2">
        <label class="flex items-center space-x-2">
          <input type="radio" name="image_option" value="debian" class="text-sky-500 focus:ring-sky-500">
          <span>Solo Debian 12</span>
        </label>
        <label class="flex items-center space-x-2">
          <input type="radio" name="image_option" value="ubuntu" class="text-sky-500 focus:ring-sky-500">
          <span>Solo Ubuntu 22.04</span>
        </label>
        <label class="flex items-center space-x-2">
          <input type="radio" name="image_option" value="ambas" class="text-sky-500 focus:ring-sky-500" checked>
          <span>Ambas (Ubuntu 22.04 y Debian 12)</span>
        </label>
      </div>
    </section>

    <!-- Sabores -->
    <section class="bg-slate-900/80 p-6 rounded-xl border border-slate-800 shadow-md mb-8">
      <h2 class="text-xl font-semibold text-sky-400 mb-4">ğŸ§± Sabores (Flavors)</h2>
      <table class="w-full text-sm text-slate-300 border-collapse border border-slate-800">
        <thead class="bg-slate-800 text-slate-300">
          <tr>
            <th class="p-2 border border-slate-700">Nombre</th>
            <th class="p-2 border border-slate-700">vCPUs</th>
            <th class="p-2 border border-slate-700">RAM (MB)</th>
            <th class="p-2 border border-slate-700">Disco (GB)</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>tiny</td><td><input value="1" class="input-table editable"></td><td><input value="512" class="input-table editable"></td><td><input value="5" class="input-table editable"></td></tr>
          <tr><td>small</td><td><input value="1" class="input-table editable"></td><td><input value="1024" class="input-table editable"></td><td><input value="10" class="input-table editable"></td></tr>
          <tr><td>medium</td><td><input value="2" class="input-table editable"></td><td><input value="2048" class="input-table editable"></td><td><input value="20" class="input-table editable"></td></tr>
          <tr><td>large</td><td><input value="4" class="input-table editable"></td><td><input value="4096" class="input-table editable"></td><td><input value="40" class="input-table editable"></td></tr>
        </tbody>
      </table>
    </section>

    
  </main>

  <!-- ğŸ”¹ Estilos base -->
  <style>
    body { font-family: 'Inter', system-ui, sans-serif; }

    .input {
      background: #1e293b;
      border: 1px solid #334155;
      padding: 8px 10px;
      border-radius: 6px;
      width: 100%;
      color: #e2e8f0;
      transition: all 0.2s;
    }

    .input:focus {
      outline: none;
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px #38bdf8;
    }

    .input-table {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 6px;
      padding: 4px;
      text-align: center;
      color: #e2e8f0;
      width: 100%;
      transition: all 0.2s;
    }

    .editable:hover {
      background: rgba(56,189,248,0.05);
      border-color: #38bdf8;
    }

    .modal-overlay { backdrop-filter: blur(6px); }
    .modal-content { background: #1e293b; border: 1px solid #334155; }
  </style>

  <!-- ğŸ”¹ Scripts -->
<script>
let configGuardada = false;

// ğŸ§  Actualiza visualmente el estado de configuraciÃ³n
function actualizarEstadoConfiguracion(guardada) {
  const statusDot = document.getElementById("status-dot");
  const statusText = document.getElementById("status-text");
  const hora = new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });

  if (guardada) {
    statusDot.className = "w-3 h-3 rounded-full bg-emerald-400 animate-pulse";
    statusText.textContent = "ConfiguraciÃ³n guardada";
    statusText.classList.remove("text-slate-300");
    statusText.classList.add("text-emerald-400");
    statusText.nextElementSibling.textContent = `Ãšltimo guardado: ${hora}`;
  } else {
    statusDot.className = "w-3 h-3 rounded-full bg-rose-500 animate-pulse";
    statusText.textContent = "ConfiguraciÃ³n no guardada";
    statusText.classList.remove("text-emerald-400");
    statusText.classList.add("text-slate-300");
    statusText.nextElementSibling.textContent = "Ãšltimo cambio: pendiente";
  }
}

// âœ… Valida puertos personalizados
function validarPuertos() {
  const input = document.getElementById("custom_ports");
  const errorMsg = document.getElementById("puertos-error");
  const ports = input.value.split(";").map(p => p.trim()).filter(p => p !== "");
  const invalid = ports.some(p => isNaN(p) || Number(p) < 1 || Number(p) > 65535);

  if (invalid) {
    input.classList.add("border-rose-500");
    errorMsg.classList.remove("hidden");
  } else {
    input.classList.remove("border-rose-500");
    errorMsg.classList.add("hidden");
  }

  // Marcar como "no guardado"
  configGuardada = false;
  actualizarEstadoConfiguracion(false);
}

// ğŸ§© Detecta cambios en los campos editables
document.addEventListener("DOMContentLoaded", () => {
  actualizarEstadoConfiguracion(false);

  const detectores = document.querySelectorAll(
    ".editable, input[type='radio'], select, input[type='checkbox']"
  );

  detectores.forEach((el) => {
    el.addEventListener("change", () => {
      configGuardada = false;
      actualizarEstadoConfiguracion(false);
    });
    el.addEventListener("input", () => {
      configGuardada = false;
      actualizarEstadoConfiguracion(false);
    });
  });
});

// ğŸ’¾ Guardar configuraciÃ³n
document.getElementById("save-config").onclick = () => {
  const imageOption = document.querySelector('input[name="image_option"]:checked').value;

  // Captura las reglas marcadas
  const reglas = Array.from(document.querySelectorAll("input[type='checkbox']:checked"))
    .map((cb) => cb.parentElement.textContent.trim());

  // Captura y valida puertos personalizados
  const customPortsInput = document.getElementById("custom_ports").value.trim();
  const customPorts = customPortsInput
    ? customPortsInput.split(";").map(p => p.trim()).filter(p => p !== "")
    : [];

  const invalidPorts = customPorts.some(p => isNaN(p) || Number(p) < 1 || Number(p) > 65535);
  if (invalidPorts) {
    alert("âš ï¸ Hay puertos invÃ¡lidos. Corrige los valores antes de guardar.");
    document.getElementById("custom_ports").classList.add("border-rose-500");
    return;
  }

  const config = {
    red_externa: document.getElementById("cidr_externa").value,
    red_privada: document.getElementById("cidr_privada").value,
    image_choice: imageOption,
    reglas_seguridad: reglas,
    puertos_personalizados: customPorts
  };

  console.log("ğŸ§¾ ConfiguraciÃ³n guardada:", config);
  configGuardada = true;
  actualizarEstadoConfiguracion(true);

  // Efecto visual elegante
  const statusCard = document.getElementById("status-card");
  statusCard.classList.add("ring", "ring-emerald-400/40");
  setTimeout(() => statusCard.classList.remove("ring", "ring-emerald-400/40"), 1000);
};

// ğŸš€ Ejecutar Generador
document.getElementById("apply-config").onclick = () => {
  if (!configGuardada) {
    showModal(
      "âš ï¸ ConfiguraciÃ³n no guardada",
      "Debes guardar la configuraciÃ³n antes de ejecutar el generador.",
      () => {}
    );
    return;
  }
  showModal("ğŸš€ Ejecutar Generador", "Â¿Deseas generar la configuraciÃ³n Terraform en OpenStack?", () => {
    document.getElementById("overlay").classList.remove("hidden");
    fetch("/api/run-generator", { method: "POST" })
      .finally(() => document.getElementById("overlay").classList.add("hidden"));
  });
};

// ğŸ§¨ Destruir ConfiguraciÃ³n
document.getElementById("destroy-config").onclick = () => {
  if (!configGuardada) {
    showModal(
      "âš ï¸ ConfiguraciÃ³n no guardada",
      "No puedes destruir una configuraciÃ³n inexistente.",
      () => {}
    );
    return;
  }
  showModal("ğŸ§¨ Destruir ConfiguraciÃ³n", "Â¿Seguro que deseas destruir todos los recursos?", () => {
    document.getElementById("overlay").classList.remove("hidden");
    fetch("/api/destroy-config", { method: "POST" })
      .finally(() => document.getElementById("overlay").classList.add("hidden"));
  });
};

// ğŸªŸ Modal genÃ©rico reutilizable
function showModal(titulo, mensaje, onConfirm) {
  const modal = document.getElementById("customModal");
  document.getElementById("modalTitle").textContent = titulo;
  document.getElementById("modalMessage").textContent = mensaje;
  modal.classList.remove("hidden");
  document.getElementById("modalCancel").onclick = () => modal.classList.add("hidden");
  document.getElementById("modalConfirm").onclick = () => {
    modal.classList.add("hidden");
    onConfirm();
  };
}
</script>



  <!-- ğŸ”¹ Modal de confirmaciÃ³n -->
  <div id="customModal" class="modal-overlay hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center">
    <div class="modal-content p-6 rounded-xl shadow-lg w-[28rem] text-center">
      <h3 id="modalTitle" class="text-xl font-bold mb-4 text-sky-400">Confirmar acciÃ³n</h3>
      <p id="modalMessage" class="text-slate-300 mb-6">Â¿EstÃ¡s seguro de que deseas proceder?</p>
      <div class="flex justify-center space-x-4">
        <button id="modalCancel" class="py-2 px-4 bg-slate-600 hover:bg-slate-500 rounded-lg text-white font-medium">Cancelar</button>
        <button id="modalConfirm" class="py-2 px-4 bg-rose-600 hover:bg-rose-500 rounded-lg text-white font-medium">Confirmar</button>
      </div>
    </div>
  </div>

  <!-- ğŸ”¹ Overlay de bloqueo -->
  <div id="overlay" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center">
    <div class="text-white text-2xl font-bold animate-pulse">ğŸš€ Procesando acciÃ³n... por favor espera unos minutos.</div>
  </div>

</body>
</html>
